<!DOCTYPE html>
<html>
<head>
    <title>Data Analysis and Visualization</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- Bootstrap Multiselect CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.16/css/bootstrap-multiselect.css">

    <!-- Bootstrap Multiselect JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.16/js/bootstrap-multiselect.js"></script>
    <!-- Include Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
   h2 {
      margin-bottom:0;
    }
   h3 {
      margin:0 0 30px;
    }
   .ui-slider-range {
       background:gray;
    }
   .percent {
      color:gray;
      font-weight:bold;
      text-align:center;
      width:100%;
      border:none;
    }






    </style>
</head>
<body>
{% include 'NavBar/navbar.html' %}

<div class="container mt-5">
    <h2 class="text-center">Data Analysis and Visualization</h2>
    <div class="row">
        <!-- Left section: Display feature selection and reconstruct signal -->
        <div class="col-md-2">
            <a href="{% url 'signal_visualization_view' file_id %}" class="btn btn-primary mt-3">Reconstruct Signal</a>

            <div>
                <!-- Start with Modal Channel selection panel -->
                <a data-target="#myModal" data-toggle="modal" class="btn btn-primary mt-3" id="MainNavHelp"
                   href="#myModal">Signal Customization</a>
                <!-- Start Channel selection panel Modal -->
                <div id="myModal" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Channel Selection Panel</h4>
                            </div>
                            <div class="modal-body">
                                <div class="container mt-4">
                                    <div class="row">
                                        <!-- Left side: Channel Selection -->
                                        <div class="col-md-6">
                                            <h4 class="modal-title">Channel Selection</h4>
                                            <div class="custom-dropdown">
                                                <button class="dropdown-toggle" data-bs-toggle="dropdown">Channel
                                                    Selection
                                                </button>
                                                <div class="dropdown-menu" id="channelSelectionMenu">
                                                    <div class="dropdown-item">
                                                        <input type="checkbox" id="optionAllChannels">
                                                        <label for="optionAllChannels">Select all channels</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button class="btn btn-primary" id="apply-channel-selection">Apply Channel Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Modal Channel Selection -->
            </div>
            <div>
                <!-- Start with Modal Feature and Channel selection -->
                <a data-target="#feature_channel_selection_modal" data-toggle="modal" class="btn btn-primary mt-3"
                   id="feature_channel_selection_modal_btn" href="#feature_channel_selection_modal">Feature & Channel
                    Selection</a>

                <div id="feature_channel_selection_modal" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Feature & Channel Selection</h4>
                            </div>
                            <div class="modal-body">
                                <div class="container mt-4">
                                    <div class="row">
                                        <!-- Left side: Channel Selection -->
                                        <div class="col-md-6">
                                            <h4 class="modal-title">Channel Selection</h4>
                                            <div class="custom-dropdown">
                                                <button class="dropdown-toggle" data-toggle="dropdown">Channel
                                                    Selection
                                                </button>
                                                <div class="dropdown-menu" id="newChannelSelectionMenu">
                                                    <div class="dropdown-item">
                                                        <input type="checkbox" id="optionAllChannels_data_analysis">
                                                        <label for="optionAllChannels_data_analysis">Select all
                                                            channels</label>
                                                    </div>
                                                    <!-- More channel selection options here -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right side: Feature Selection -->
                                        <h4 class="modal-title">Feature Selection</h4>
                                        <div class="custom-dropdown">
                                            <button class="dropdown-toggle" data-toggle="dropdown" id="featureDropdown">
                                                Feature Selection
                                            </button>
                                            <div class="dropdown-menu" id="newFeatureSelectionMenu"
                                                 aria-labelledby="featureDropdown" multiple
                                                 style="height: auto; max-height: 200px; overflow-y: auto;">
                                                <!-- Dynamic feature items will be added here -->
                                            </div>
                                        </div>
                                         <div>
                                             <label>Window Length</label>

                                             <input type="number" id="windowLength" name="window_length">
                                         </div>
                                        <div class="container">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="text-center">Window Overlap</label>
                                                    <h4 class="text-center">
                                                        <span class="percent">0%</span>
                                                    </h4>
                                                    <div class="bar">
                                                        <input type="range" min="0" max="100" value="0" class="slider"
                                                               step="5" style="width: 100%;"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button class="btn btn-primary" id="apply-channel-feature-selection">Apply Channel &
                                    Feature Selection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Modal Feature & Channel Selection -->
            </div>


            <!-- Middle section: Display data table (60% width) -->
            <div class="col-md-8">
                <h4 class="text-center">File Content</h4>
                <div class="table-container">
                    <table class="table table-striped table-bordered table-hover data-table">
                        <thead>
                        {% for column in column_names %}
                        <th>{{ column }}</th>
                        {% endfor %}
                        </thead>
                        <tbody>
                        {% for row in file_content %}
                        <tr>
                            {% for cell in row %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if validation_errors %}
                <div class="alert alert-danger">
                    <strong>Validation Errors:</strong>
                    <ul>
                        {% for error in validation_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Right section: Generate Pandas Profiling Report (40% width) -->
            <div class="col-md-2">
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-block" name="generate_report">Generate Profiling
                        Report
                    </button>
                </form>
                {% if profile_html %}
                {{ profile_html|safe }}
                {% else %}
                <p>No data available for profiling.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% include 'headerFooter/footer.html' %}


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


    <script>

    var overlapPercentageValue = null;

    // JavaScript for handling the "Select all channels" checkbox (only channel visualization)
  $('#optionAllChannels').change(function() {
        let checked = $(this).prop('checked');
        $('input[type="checkbox"]:not("#optionAllChannels")').prop('checked', checked);
    });


    // all Feature and channel selection modal ( all feature  and channel visualization)
    $('#optionAllChannels_data_analysis').change(function() {
        let checked = null;
        checked = $(this).prop('checked');
        $('input[type="checkbox"]').prop('checked', checked);
        });


    // sole or multiple Channel selection and visualization ( id = apply-channel-selection)
    $('#apply-channel-selection').click(function() {
        // Collect the selected channels and perform further actions (e.g., visualization)
        const selectedChannels = [];
        $('input[type="checkbox"]:checked').each(function() {
            if (this.id !== "optionAllChannels") {
                const numericPart = this.id.replace("channel", ""); // Extract the numeric part
                selectedChannels.push(numericPart); // Add the numeric part to the array
            }
        });

        // Redirect or perform visualization based on selected channels
        if (selectedChannels.length > 0) {
            // Construct the URL to visualize the selected channels
            let url = "{% url 'visualize_channels' file_id %}?channels=";
            url += selectedChannels.join(',');
            window.location.href = url;
        } else {
            // No channels selected, show an alert or take appropriate action
            alert("Please select at least one channel.");
        }
    });


    // Function to dynamically generate channel selection options
    function generateChannelOptions(numColumns) {
        var menu = document.getElementById("channelSelectionMenu");

        for (var i = 1; i <= numColumns; i++) {
            var div = document.createElement("div");
            div.className = "dropdown-item";

            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "channel" + i;
            checkbox.className = "channel-checkbox";

            var label = document.createElement("label");
            label.htmlFor = "channel" + i;
            label.textContent = "Channel " + i;

            div.appendChild(checkbox);
            div.appendChild(label);
            menu.appendChild(div);
        }
    }
    // Function to dynamically generate channel selection options channel and feature modal
    function generateChannelOptionsForDataAnalysis(numColumns) {
        var menu = document.getElementById("newChannelSelectionMenu");

        for (var i = 1; i <= numColumns; i++) {
            var div = document.createElement("div");
            div.className = "dropdown-item";

            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "channel" + i;
            checkbox.className = "channel-checkbox";

            var label = document.createElement("label");
            label.htmlFor = "channel" + i;
            label.textContent = "Channel " + i;

            div.appendChild(checkbox);
            div.appendChild(label);
            menu.appendChild(div);
        }
    }

    // Function to dynamically generate feature selection options in the modal
function generateFeatureOptions(numFeatures) {
    var menu = document.getElementById("newFeatureSelectionMenu");

    for (var i = 1; i <= numFeatures; i++) {
        var a = document.createElement("a");
        a.className = "dropdown-item";
        a.href = "#";
        a.setAttribute("value", "feature" + i);
        a.textContent = "Feature " + i;

        a.addEventListener("click", function(e) {
            e.preventDefault();
            this.classList.toggle("active");
        });

        menu.appendChild(a);
    }
}

// Example usage - call the function to generate features dynamically
generateFeatureOptions(30); // Change the argument to the number of features you have


    // Call the function with the desired value of num_columns
    generateChannelOptions({{ num_columns }});
    generateChannelOptionsForDataAnalysis({{ num_columns }});


// Features and channel selection for feature calculation
document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("apply-channel-feature-selection").addEventListener("click", function() {
            // Retrieve selected channels
            const selectedChannels = Array.from(document.querySelectorAll("#newChannelSelectionMenu input[type='checkbox']:checked")).map(channel => channel.value);

            // Retrieve selected features
            const selectedFeatures = Array.from(document.querySelectorAll("#newFeatureSelectionMenu .dropdown-item.active")).map(feature => feature.getAttribute("value"));

            //Retrieve the Window length
            var windowLength = $('#windowLength').val();

            // Construct query parameters
            const queryParams = new URLSearchParams();
            selectedChannels.forEach(channel => {
                queryParams.append('channels', channel);
            });
            selectedFeatures.forEach(feature => {
                queryParams.append('features', feature);
            });
             queryParams.append('windowLength', String(windowLength).trim());
                 queryParams.append('windowOverLapValue', String(overlapPercentageValue).trim());
            let url = "{% url 'view_features_calculation' file_id %}?channels=";
            url += queryParams.toString();
            window.location.href = url;
        });
    });

    // Testing the overlap selection
     document.addEventListener('DOMContentLoaded', function() {
          var slider = document.querySelector('.slider');
          var percent = document.querySelector('.percent');

          slider.addEventListener('input', function() {
            var value = this.value;
            overlapPercentageValue = value;
            percent.textContent = value + '%';
          });
        });

    </script>
</body>
</html>